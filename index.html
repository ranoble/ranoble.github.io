<html>
<head>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script src="/compass.js"></script>
<style>

</style>
</head>
<body>
<!-- <video id="video" width="640" height="480" autoplay></video> -->
<canvas id="canvas" width="640" height="480"></canvas>



<script>
$(document).ready(function(){
	  var field_of_view = 63.54;
	  var pub = {
		"lat": 51.517803,
		"lng":-0.143787
	  };
	  
	  var me = {
	  	"lat": 51.5210211,
	  	"lng": -0.1422322
	  }
	  
	  var params = {
	    // coords of the user at the current point
	  	"location": null,
	  	// between points
	  	"bearing": null,
	  	// where on the screen is the target point situated
	  	"view_position": null,
	  	// how far until the pub
	  	"distance": null,
	  	// from compass
	  	"heading": null
	  }
	  
      function updateLocation(position){
	  	params.location = {
	  		'lat': position.coords.latitude, 
	  		'lng': position.coords.longitude
	  	};
	  	
	  	updateView();
	  }
	  
	
	  var geo = {
        /**
         * Calculate the bearing between two positions as a value from 0-360
         *
         * @param lat1 - The latitude of the first position
         * @param lng1 - The longitude of the first position
         * @param lat2 - The latitude of the second position
         * @param lng2 - The longitude of the second position
         *
         * @return int - The bearing between 0 and 360
         */
        bearing : function (lat1,lng1,lat2,lng2) {
            var dLon = this._toRad(lng2-lng1);
            var y = Math.sin(dLon) * Math.cos(this._toRad(lat2));
            var x = Math.cos(this._toRad(lat1))*Math.sin(this._toRad(lat2)) - Math.sin(this._toRad(lat1))*Math.cos(this._toRad(lat2))*Math.cos(dLon);
            var brng = this._toDeg(Math.atan2(y, x));
            return ((brng + 360) % 360);
        },

       /**
         * Since not all browsers implement this we have our own utility that will
         * convert from degrees into radians
         *
         * @param deg - The degrees to be converted into radians
         * @return radians
         */
        _toRad : function(deg) {
             return deg * Math.PI / 180;
        },

        /**
         * Since not all browsers implement this we have our own utility that will
         * convert from radians into degrees
         *
         * @param rad - The radians to be converted into degrees
         * @return degrees
         */
        _toDeg : function(rad) {
            return rad * 180 / Math.PI;
        },
        
        distance: function(lat1, lon1, lat2, lon2) {
		  var p = 0.017453292519943295;    // Math.PI / 180
 		  var c = Math.cos;
		  var a = 0.5 - c((lat2 - lat1) * p)/2 + c(lat1 * p) * c(lat2 * p) * (1 - c((lon2 - lon1) * p))/2;

		  return 12742 * Math.asin(Math.sqrt(a)); // 2 * R; R = 6371 km
		},
		
		watch_location: function(){
			if (navigator.geolocation) {
       			navigator.geolocation.watchPosition(updateLocation);
    		}
		},
		
		calculate_viewposition: function(params){
			var deviance_allowed = field_of_view / 2;
			log(deviance_allowed);
			var anglediff = (params.heading - params.bearing + 180 + 360) % 360 - 180;
			log(anglediff);
			if (((deviance_allowed * -1) < anglediff) || ((deviance_allowed) > anglediff)){
				log(anglediff + deviance_allowed) / field_of_view) * 100.0;
				return ((anglediff + deviance_allowed) / field_of_view) * 100.0;
			}
			return -1;
			
		}
    };
    

	  function updateView(){
	  	if (params.location != null && params.heading != null){
	  		params.distance = geo.distance(params.location.lat, params.location.lng, pub.lat, pub.lng);
	  		params.bearing = geo.bearing(params.location.lat, params.location.lng, pub.lat, pub.lng);
	  		params.viewposition = geo.calculate_viewposition(params);
	  	}
	  	$('.degrees').text(JSON.stringify(params));
	  }

    /** Usage **/
    var myInitialBearing = geo.bearing(me.lat,me.lng,pub.lat,pub.lng);
    
    //51.5210211,-0.1422322
    
    function log(txt){
     	$('.stdout').text($('.stdout').text() + '\n' + txt);
    }
    
    log('Initial bearing ' + myInitialBearing);
	log('Initial distance ' + geo.distance(me.lat,me.lng,pub.lat,pub.lng));
	
	
	Compass.init(function (method) {
	  log('Compass heading by ' + method);
	});
	var watchID = Compass.watch(function (heading) {
	  //$('.degrees').text(heading);
	  params.heading = heading;
	  updateView();
	  //get width
	  //get bearing wrt view
	  //position 
	});
	geo.watch_location();
	
	var video = document.getElementById('video');

    // Get access to the camera!
    if(navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
        // Not adding `{ audio: true }` since we only want video now
        navigator.mediaDevices.getUserMedia({ video: true }).then(function(stream) {
            video.src = window.URL.createObjectURL(stream);
            video.play();
        });
    }
});
</script>
Direction: <div class="degrees"></div>
Out: <div class="stdout"></div>
</body>
</html>